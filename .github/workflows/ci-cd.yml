name: CI/CD Pipeline - Wisecow

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Set up Docker Buildx (for multi-platform images if needed)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 3. Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. Build Docker image
      - name: Build Docker image
        run: |
          docker build -t sonukumar2003/wisecow:latest .
          docker tag sonukumar2003/wisecow:latest sonukumar2003/wisecow:${{ github.sha }}

      # 5. Push Docker image
      - name: Push Docker image
        run: |
          docker push sonukumar2003/wisecow:latest
          docker push sonukumar2003/wisecow:${{ github.sha }}

      # 6. Install kind (Kubernetes in Docker)
      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.26.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      # 7. Create a local Kubernetes cluster
      - name: Create kind cluster
        run: kind create cluster --name wisecow-cluster

      # 8. Verify kubectl
      - name: Verify cluster
        run: kubectl get nodes

      # 9. Deploy app to Kubernetes
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s-manifests/
          kubectl set image deployment/wisecow-deployment wisecow=sonukumar2003/wisecow:${{ github.sha }}
          kubectl rollout status deployment/wisecow-deployment
